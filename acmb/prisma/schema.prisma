generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(uuid())
  email                    String                    @unique
  password                 String
  name                     String
  role                     UserRole                  @default(STUDENT)
  phone                    String?                   @unique
  status                   AccountStatus             @default(ACTIVE)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  isVerified               Boolean                   @default(false)
  resetToken               String?
  resetTokenExpiresAt      DateTime?
  verifyToken              String
  verifyTokenExpiresAt     DateTime?
  isDeleted                Boolean                   @default(false)
  deletedAt                DateTime?
  lastLogin                DateTime?
  resourceFlagsReported    AcademicResourceFlag[]    @relation("AcademicResourceFlagsReported")
  resourceFlagsReviewed    AcademicResourceFlag[]    @relation("AcademicResourceFlagsReviewed")
  comments                 Comment[]
  commentLikes             CommentLike[]
  messages                 ConversationMessage[]
  participants             ConversationParticipant[]
  following                Follow[]                  @relation("following")
  followers                Follow[]                  @relation("followers")
  groupsCreated            Group[]                   @relation("GroupCreator")
  groupMemberships         GroupMember[]
  groupMessages            GroupMessage[]
  groupResources           GroupResource[]
  groupResourceLikes       GroupResourceLike[]
  groupResourceComments    GroupResourceComment[]
  groupResourceCommentLikes GroupResourceCommentLike[]
  createdInstitutionAdmins InstitutionAdmin[]        @relation("CreatedInstitutionAdmins")
  institutionAdmins        InstitutionAdmin[]
  announcements            InstitutionAnnouncement[]
  interactions             Interaction[]
  likes                    Like[]
  notifications            Notification[]            @relation("UserNotifications")
  posts                    Post[]
  reportedFlags            PostFlag[]
  profile                  Profile?
  profileViewsReceived     ProfileView[]             @relation("Viewed")
  profileViewsMade         ProfileView[]             @relation("Viewer")
  requests                 Request[]
  activityLogs             ResourceActivityLog[]
  adminSuspensions         UserSuspension[]          @relation("AdminSuspensions")
  restoredSuspensions      UserSuspension[]          @relation("UserSuspensionRestorer")
  userSuspensions          UserSuspension[]          @relation("UserSuspensions")
}

model Institution {
  id            String                    @id @default(uuid())
  name          String                    @unique
  description   String?
  logoUrl       String?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  admins        InstitutionAdmin[]
  announcements InstitutionAnnouncement[]
  invites       InstitutionInvite[]
  profiles      Profile[]
}

model InstitutionAdmin {
  id            String      @id @default(uuid())
  userId        String
  institutionId String
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  createdById   String
  createdBy     User        @relation("CreatedInstitutionAdmins", fields: [createdById], references: [id])
  institution   Institution @relation(fields: [institutionId], references: [id])
  user          User        @relation(fields: [userId], references: [id])

  @@unique([userId, institutionId])
  @@index([institutionId])
}

model InstitutionInvite {
  id            String      @id @default(uuid())
  email         String
  institutionId String
  token         String      @unique
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
  usedAt        DateTime?
  createdBy     String?
  isActive      Boolean     @default(true)
  createdById   String
  institution   Institution @relation(fields: [institutionId], references: [id])
}

model InstitutionAnnouncement {
  id            String      @id @default(uuid())
  title         String
  fileUrls      String[]
  content       String
  isPublished   Boolean     @default(false)
  publishedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  institutionId String
  createdById   String
  createdBy     User        @relation(fields: [createdById], references: [id])
  institution   Institution @relation(fields: [institutionId], references: [id])
}

model Profile {
  id                String             @id @default(uuid())
  name              String
  academicLevel     String
  skills            String[]
  bio               String?
  profileImage      String?
  coverPhoto        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userId            String             @unique
  interests         String[]
  course            String?
  institutionId     String
  academicResources AcademicResource[]
  postLikes         Like[]
  institution       Institution        @relation(fields: [institutionId], references: [id])
  user              User               @relation(fields: [userId], references: [id])

  @@index([skills], type: Gin)
  @@index([interests], type: Gin)
  @@index([institutionId])
  @@index([course])
  @@index([academicLevel])
}

model UserSuspension {
  id             String    @id @default(uuid())
  userId         String
  adminId        String
  reason         String?
  createdAt      DateTime  @default(now())
  restoredAt     DateTime?
  restoredBy     String?
  admin          User      @relation("AdminSuspensions", fields: [adminId], references: [id])
  restoredByUser User?     @relation("UserSuspensionRestorer", fields: [restoredBy], references: [id])
  user           User      @relation("UserSuspensions", fields: [userId], references: [id])
}

model Notification {
  id          String             @id @default(uuid())
  recipientId String
  type        NotificationType
  referenceId String?
  message     String
  status      NotificationStatus @default(UNREAD)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  readAt      DateTime?
  recipient   User               @relation("UserNotifications", fields: [recipientId], references: [id])

  @@index([recipientId])
  @@index([status])
  @@index([createdAt])
}

model Follow {
  id          String @id @default(uuid())
  followerId  String
  followingId String
  follower    User   @relation("following", fields: [followerId], references: [id])
  following   User   @relation("followers", fields: [followingId], references: [id])
}

model ProfileView {
  id        String   @id @default(uuid())
  viewerId  String
  viewedId  String
  createdAt DateTime @default(now())
  viewed    User     @relation("Viewed", fields: [viewedId], references: [id])
  viewer    User     @relation("Viewer", fields: [viewerId], references: [id])
}

model Post {
  id            String        @id @default(uuid())
  title         String
  body          String?
  fileUrl       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  type          PostType      @default(GENERAL)
  isDeleted     Boolean       @default(false)
  deletedAt     DateTime?
  authorId      String
  commentsCount Int           @default(0)
  likesCount    Int           @default(0)
  comments      Comment[]
  interactions  Interaction[]
  likes         Like[]
  author        User          @relation(fields: [authorId], references: [id])
  flags         PostFlag[]
  tags          PostTag[]

  @@index([createdAt], map: "idx_post_createdAt")
  @@index([authorId, createdAt], map: "idx_post_author_createdAt")
  @@index([isDeleted, createdAt], map: "idx_post_isDeleted_createdAt")
}

model Like {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  profileId String?
  createdAt DateTime @default(now())
  deleted   Boolean  @default(false)
  post      Post     @relation(fields: [postId], references: [id])
  profile   Profile? @relation(fields: [profileId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model Comment {
  id        String        @id @default(uuid())
  body      String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  userId    String
  postId    String?
  parentId  String?
  deleted   Boolean       @default(false)
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]     @relation("CommentReplies")
  post      Post?         @relation(fields: [postId], references: [id])
  user      User          @relation(fields: [userId], references: [id])
  likes     CommentLike[]
}

model PostFlag {
  id         String     @id @default(cuid())
  postId     String
  reporterId String
  reason     String?
  status     FlagStatus @default(PENDING)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  post       Post       @relation(fields: [postId], references: [id])
  reporter   User       @relation(fields: [reporterId], references: [id])

  @@index([postId])
  @@index([reporterId])
}

model Request {
  id          String        @id @default(uuid())
  title       String
  description String
  status      RequestStatus
  createdAt   DateTime      @default(now())
  userId      String
  user        User          @relation(fields: [userId], references: [id])
}

model Interaction {
  id        String          @id @default(uuid())
  userId    String
  postId    String
  type      interactionType
  createdAt DateTime        @default(now())
  post      Post            @relation(fields: [postId], references: [id])
  user      User            @relation(fields: [userId], references: [id])
}

model CommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, commentId])
}

model AcademicResource {
  id            String                 @id @default(uuid())
  title         String
  description   String
  course        String
  unitName      String
  semester      String
  year          String
  institution   String
  fileUrl       String?
  uploadedAt    DateTime               @default(now())
  uploaderId    String
  downloadCount Int                    @default(0)
  deletedAt     DateTime?
  isDeleted     Boolean                @default(false)
  approvedAt    DateTime?
  approvedBy    String?
  isApproved    Boolean                @default(false)
  uploader      Profile                @relation(fields: [uploaderId], references: [id])
  flags         AcademicResourceFlag[]
  activityLogs  ResourceActivityLog[]
}

model AcademicResourceFlag {
  id           String           @id @default(cuid())
  resourceId   String
  reporterId   String
  reviewedById String?
  reason       String
  status       FlagStatus       @default(PENDING)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  reporter     User             @relation("AcademicResourceFlagsReported", fields: [reporterId], references: [id])
  resource     AcademicResource @relation(fields: [resourceId], references: [id])
  reviewedBy   User?            @relation("AcademicResourceFlagsReviewed", fields: [reviewedById], references: [id])

  @@index([resourceId])
  @@index([reporterId])
  @@index([reviewedById])
}

model ResourceActivityLog {
  id         String           @id @default(uuid())
  resourceId String
  userId     String?
  action     ResourceAction
  details    String?
  createdAt  DateTime         @default(now())
  resource   AcademicResource @relation(fields: [resourceId], references: [id])
  user       User?            @relation(fields: [userId], references: [id])

  @@index([resourceId])
  @@index([userId])
}

model Tag {
  id    String    @id @default(uuid())
  name  String    @unique
  posts PostTag[]
}

model PostTag {
  postId String
  tagId  String
  post   Post   @relation(fields: [postId], references: [id])
  tag    Tag    @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

model Group {
  id          String          @id @default(uuid())
  name        String
  description String?
  coverImage  String?
  visibility  GroupVisibility @default(PUBLIC)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  creatorId   String
  creator     User            @relation("GroupCreator", fields: [creatorId], references: [id])
  members     GroupMember[]
  messages    GroupMessage[]
  resources   GroupResource[]
}

model GroupMember {
  id        String    @id @default(uuid())
  groupId   String
  userId    String
  role      GroupRole @default(MEMBER)
  joinedAt  DateTime  @default(now())
  deletedAt DateTime?
  isDeleted Boolean   @default(false)
  group     Group     @relation(fields: [groupId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
}

model GroupMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  groupId   String
  userId    String
  group     Group    @relation(fields: [groupId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model GroupResource {
  id            String   @id @default(uuid())
  title         String
  resourceUrl   String?
  content       String?
  originalName  String?
  fileType      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  groupId       String
  sharedById    String
  isDeleted     Boolean  @default(false)
  likesCount    Int      @default(0)
  commentsCount Int      @default(0)
  group         Group    @relation(fields: [groupId], references: [id])
  sharedBy      User     @relation(fields: [sharedById], references: [id])
  likes         GroupResourceLike[]
  comments      GroupResourceComment[]

  @@index([groupId])
  @@index([sharedById])
  @@index([isDeleted, createdAt])
}

model GroupResourceLike {
  id         String   @id @default(uuid())
  userId     String
  resourceId String
  createdAt  DateTime @default(now())
  resource   GroupResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([resourceId])
  @@index([userId])
}

model GroupResourceComment {
  id         String   @id @default(uuid())
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String
  resourceId String
  isDeleted  Boolean  @default(false)
  resource   GroupResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes      GroupResourceCommentLike[]

  @@index([resourceId])
  @@index([userId])
  @@index([isDeleted, createdAt])
}

model GroupResourceCommentLike {
  id        String   @id @default(uuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  comment   GroupResourceComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
  @@index([userId])
}

model Conversation {
  id           String                    @id @default(uuid())
  title        String?
  isGroup      Boolean                   @default(false)
  oneOnOneKey  String?                   @unique
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  messages     ConversationMessage[]
  participants ConversationParticipant[]
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  lastReadAt     DateTime?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

model ConversationMessage {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  content        String?
  attachments    Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
}

enum GroupRole {
  OWNER
  ADMIN
  MEMBER
}

enum GroupVisibility {
  PUBLIC
  PRIVATE
}

enum interactionType {
  LIKE
  COMMENT
  VIEW
}

enum FlagStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum UserRole {
  ADMIN
  STUDENT
  INSTITUTION_ADMIN
}

enum AccountStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Visibility {
  PUBLIC
  STUDENTS_ONLY
  PRIVATE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CLOSED
}

enum PostType {
  GENERAL
  ACADEMIC
  OPPORTUNITY
  RESOURCE
}

enum ResourceAction {
  CREATE
  UPDATE
  DELETE_SOFT
  DELETE_HARD
  RESTORE
  FLAG
  FLAG_REVIEWED
  APPROVE
  UNPUBLISH
}

enum NotificationType {
  ANNOUNCEMENT
  POST
  COMMENT
  MESSAGE
  SYSTEM
}

enum NotificationStatus {
  UNREAD
  READ
}
