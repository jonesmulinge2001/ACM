<div class="p-6 bg-gray-50 min-h-screen">

  <!-- Page Header -->
  <div class="mb-4">
    <h1 class="text-2xl font-bold text-gray-800">Manage Groups</h1>
    <p class="text-gray-600 text-sm mt-1">View and manage all student-created groups.</p>
  </div>

  <!-- Loading -->
  <div *ngIf="loadingGroups" class="text-center py-10">
    <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-blue-500 border-b-4 border-purple-600 mx-auto"></div>
    <p class="text-gray-500 text-sm mt-2">Loading groups...</p>
  </div>

  <!-- Table -->
  <div *ngIf="!loadingGroups && groups.length > 0" class="overflow-x-auto mt-4">
    <table class="w-full bg-white rounded-lg shadow-md text-sm">
      <thead class="bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs">
        <tr>
          <th class="px-4 py-2 text-left">Name</th>
          <th class="px-4 py-2 text-left">Description</th>
          <th class="px-4 py-2 text-left">Creator</th>
          <th class="px-4 py-2 text-left">Members</th>
          <th class="px-4 py-2 text-left">Created At</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-200">
        <tr *ngFor="let group of groups" class="cursor-pointer hover:bg-gray-50 transition" (click)="viewGroupMembers(group)">
          
          <!-- Name -->
          <td class="px-4 py-3 font-medium">{{ group.name }}</td>

          <!-- Description -->
          <td class="px-4 py-3 text-gray-500 max-w-[250px]">
            <ng-container *ngIf="group.description; else noDesc">
              {{
                isExpanded(group.id)
                  ? group.description
                  : truncateDescription(group.description, 20)
              }}
              <button
                *ngIf="group.description.split(' ').length > 20"
                (click)="toggleDescription(group.id); $event.stopPropagation()"
                class="ml-1 text-indigo-600 hover:underline text-xs"
              >
                {{ isExpanded(group.id) ? "Read Less" : "Read More" }}
              </button>
            </ng-container>
            <ng-template #noDesc>No description available</ng-template>
          </td>

          <!-- Creator -->
          <td class="px-4 py-3 text-gray-600">{{ group.creator?.name || 'Unknown' }}</td>

          <!-- Members -->
          <td class="px-4 py-3">{{ group._count?.members || 0 }}</td>

          <!-- Created At -->
          <td class="px-4 py-3 text-gray-500">{{ formatDate(group.createdAt) }}</td>

          <!-- Actions -->
          <td class="px-4 py-3 text-center">
            <button
            (click)="deleteGroup(group.id); $event.stopPropagation()"
            class="inline-flex items-center gap-1 px-2 py-1 text-xs text-white bg-red-500 rounded hover:bg-red-600"
          >
            <span class="material-icons text-xs">delete</span>
            Delete
          </button>
            <!-- <button
              *ngIf="group.deletedAt"
              (click)="restoreGroup(group.id); $event.stopPropagation()"
              class="ml-1 px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600"
            >
              Restore
            </button> -->
          </td>

        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loadingGroups && groups.length === 0" class="text-center py-10 text-gray-500 text-sm">
    No groups found.
  </div>

  <!-- Overlay -->
  <div
    *ngIf="showMemberPanel"
    (click)="closePanel()"
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50"
  ></div>

  <!-- Side Panel -->
  <div
    *ngIf="showMemberPanel"
    class="fixed top-0 right-0 w-[480px] max-w-full h-full bg-white shadow-xl flex flex-col z-50"
  >
    <div
      class="flex justify-between items-start p-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white"
    >
      <div>
        <h2 class="text-xl font-semibold mb-1">{{ selectedGroup?.name }}</h2>
        <p class="text-sm opacity-90">
          {{ selectedGroup?.memberCount }} members
        </p>
      </div>
      <button
        (click)="closePanel()"
        class="w-9 h-9 flex items-center justify-center rounded-lg bg-white/20 hover:bg-white/30 transition-transform duration-300"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-4">
      <!-- Loading Members -->
      <div *ngIf="loadingMembers" class="text-gray-500">Loading members...</div>

      <!-- Member List -->
      <div
        *ngFor="let member of selectedGroupMembers"
        class="flex items-center gap-4 p-4 bg-gray-100 rounded-xl hover:bg-gray-200 hover:-translate-x-1 hover:shadow-md transition-all duration-300"
      >
        <!-- Avatar -->
        <div
          class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center font-semibold text-lg flex-shrink-0 overflow-hidden"
        >
          <img
            *ngIf="member.user?.profile?.profileImage"
            [src]="member.user?.profile?.profileImage"
            class="w-full h-full object-cover"
          />
          <span *ngIf="!member.user?.profile?.profileImage">
            {{ (member.user?.name || "?")[0] | uppercase }}
          </span>
        </div>

        <!-- Info -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-semibold text-gray-900 text-sm">{{ member.user?.name }}</span>

            <span
              [ngClass]="{
                'bg-gradient-to-r from-indigo-500 to-purple-600 text-white': member.role === 'OWNER',
                'bg-gray-200 text-gray-500': member.role !== 'OWNER'
              }"
              class="text-xs font-semibold px-2 py-0.5 rounded-full uppercase"
            >
              {{ member.role }}
            </span>
          </div>

          <span class="block text-gray-500 text-xs truncate">
            {{ member.user?.profile?.institution?.name || "Unknown Institution" }}
          </span>

          <span class="block text-gray-400 text-xs">
            Joined {{ formatDate(member.joinedAt) }}
          </span>
        </div>
      </div>
    </div>
  </div>

</div>
