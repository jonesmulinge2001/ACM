<!-- Overlay for mobile -->
<div
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 sm:hidden"
  (click)="close.emit()"
  [class.hidden]="!isChatVisible"
  [class.block]="isChatVisible"
></div>

<!-- Chat Panel -->
<div
  class="fixed right-0 h-full w-full max-w-md bg-white flex flex-col z-50 sm:max-w-sm sm:right-4 sm:bottom-4 sm:rounded-none bottom-[var(--mobile-bottom-nav-height)] sm:bottom-4 transform transition-transform duration-300"
  [class.translate-y-full]="!isChatVisible"
  [class.translate-y-0]="isChatVisible"
  (click)="$event.stopPropagation()"
>
  <!-- Header -->
  <div
    class="flex items-center justify-between px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg sticky top-0 z-10"
  >
    <div class="flex items-center gap-2">
      <img
        [src]="participantImage"
        alt="Profile"
        class="w-10 h-10 rounded-full object-cover cursor-pointer border-2 border-white shadow"
      />
      <span class="font-semibold text-sm drop-shadow-sm sm:text-base">
        {{ participantName }}
      </span>
    </div>
    <button
      (click)="close.emit(); isChatVisible = false"
      class="text-white hover:text-gray-200 transition-all text-lg font-bold"
      aria-label="Close chat"
    >
      âœ•
    </button>
  </div>

  <!-- Meta -->
  <div
    class="text-xs mt-3 text-gray-400 px-4 py-1 border-b bg-gray-50/50 backdrop-blur-sm sm:text-sm"
  >
    {{ messages.length }} messages
  </div>

  <!-- Messages -->
  <div
    class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-blue-500 scrollbar-track-gray-100 sm:p-2"
  >
    <div
      *ngFor="let msg of messages"
      [ngClass]="{
        'text-right': msg.senderId.toString() === myId,
        'text-left': msg.senderId.toString() !== myId
      }"
      class="relative"
    >
      <!-- Message bubble -->
      <div
        class="inline-block px-4 py-2 rounded-3xl text-sm max-w-[70%] break-words shadow-md transition-transform hover:scale-[1.02] sm:max-w-[85%]"
        [ngClass]="
          msg.senderId.toString() === myId
            ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg'
            : 'bg-gray-100 text-gray-800'
        "
      >
        <!-- Message content with menu for my messages -->
        <div class="relative">
          {{ msg.content }}

          <!-- Three-dot menu for my messages -->
          <div *ngIf="isMyMessage(msg)" class="absolute -top-3 -right-3">
            <!-- Menu toggle button -->
            <button
              (click)="toggleMenu(msg.id)"
              class="dm-menu-btn flex items-center justify-center w-6 h-6 rounded-full hover:bg-gray-200 bg-white shadow-sm"
              title="More options"
            >
              <span class="material-icons text-gray-600 text-sm"
                >more_vert</span
              >
            </button>

            <!-- Edit/Delete Menu -->
            <div
              *ngIf="isMenuOpen(msg.id)"
              class="dm-menu absolute right-0 top-6 bg-white shadow-lg rounded-lg p-1 min-w-[100px] z-10 border border-gray-100"
            >
              <button
                (click)="openEditModal(msg); closeMenu(msg.id)"
                class="flex items-center gap-2 w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded"
                title="Edit message"
              >
                <span class="material-icons text-sm">edit</span>
                Edit
              </button>
              <button
                (click)="openDeleteModal(msg); closeMenu(msg.id)"
                class="flex items-center gap-2 w-full px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded"
                title="Delete message"
              >
                <span class="material-icons text-sm">delete</span>
                Delete
              </button>
            </div>
          </div>
        </div>

        <!-- Attachments -->
        <ng-container *ngIf="msg.attachments?.length">
          <div class="mt-2 flex flex-col gap-2 sm:gap-1">
            <ng-container *ngFor="let att of msg.attachments">
              <div *ngIf="att.type.startsWith('image')" class="relative">
                <img
                  [src]="att.url"
                  class="rounded-md max-h-40 w-full object-contain sm:max-h-32"
                />
                <div
                  *ngIf="att.progress !== undefined && att.progress < 100"
                  class="absolute bottom-1 left-1 bg-black bg-opacity-40 text-white text-xs px-1 rounded"
                >
                  {{ att.progress }}%
                </div>
              </div>

              <div *ngIf="att.type.startsWith('video')" class="relative">
                <video
                  [src]="att.url"
                  controls
                  class="rounded-md max-h-40 w-full sm:max-h-32"
                ></video>
                <div
                  *ngIf="att.progress !== undefined && att.progress < 100"
                  class="absolute bottom-1 left-1 bg-black bg-opacity-40 text-white text-xs px-1 rounded"
                >
                  {{ att.progress }}%
                </div>
              </div>

              <div
                *ngIf="
                  !att.type.startsWith('image') && !att.type.startsWith('video')
                "
                class="flex items-center gap-1 text-sm text-gray-700"
              >
                ðŸ“Ž
                <a [href]="att.url" target="_blank" class="underline">
                  {{ att.name }}
                </a>
                <span
                  *ngIf="att.progress !== undefined && att.progress < 100"
                  class="ml-2 text-xs text-gray-500"
                >
                  {{ att.progress }}%
                </span>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </div>

      <!-- Sender info -->
      <div
        class="text-xs text-gray-400 mt-1 flex items-center gap-1 sm:text-[10px]"
      >
        <img
          *ngIf="msg.sender.profileImage"
          [src]="msg.sender.profileImage"
          alt="avatar"
          class="w-4 h-4 rounded-full object-cover border"
        />
        {{ msg.sender.name || "Unknown" }}
      </div>
    </div>

    <!-- Typing indicator -->
    <div
      *ngIf="typingUsers.length"
      class="text-sm text-gray-500 italic sm:text-xs"
    >
      {{ participantName }} is typing...
    </div>

    <!-- Typing indicator -->
    <div
      *ngIf="typingUsers.length"
      class="text-sm text-gray-500 italic sm:text-xs"
    >
      {{ participantName }} is typing...
    </div>
  </div>

  <!-- Composer -->
  <div
    class="p-3 border-t bg-gradient-to-r from-blue-50/50 to-purple-50/50 backdrop-blur-md flex flex-col gap-2 sm:p-2"
  >
    <!-- Selected attachments preview -->
    <div *ngIf="selectedAttachments.length" class="flex gap-2 overflow-x-auto">
      <div
        *ngFor="let att of selectedAttachments; let i = index"
        class="relative"
      >
        <img
          *ngIf="att.type === 'IMAGE'"
          [src]="att.previewUrl"
          class="h-16 w-16 object-cover rounded-md sm:h-12 sm:w-12"
        />
        <video
          *ngIf="att.type === 'VIDEO'"
          [src]="att.previewUrl"
          class="h-16 w-16 rounded-md sm:h-12 sm:w-12"
          controls
        ></video>
        <div
          class="absolute top-0 right-0 cursor-pointer text-white bg-black bg-opacity-60 rounded-full px-1"
          (click)="removeAttachment(i)"
        >
          âœ•
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <input
        [(ngModel)]="newMessage"
        (input)="onInputChange()"
        (keyup.enter)="sendMessage()"
        type="text"
        placeholder="Write a message..."
        class="flex-1 px-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-70 shadow-inner sm:text-xs sm:px-3 sm:py-1"
      />

      <input
        #fileInput
        type="file"
        (change)="onFileSelected($event)"
        class="hidden"
        multiple
      />
      <button
        (click)="fileInput.click()"
        class="px-3 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition sm:px-2 sm:py-1"
      >
        <span class="material-icons text-[18px] sm:text-[14px]"
          >attach_file</span
        >
      </button>

      <button
        (click)="sendMessage()"
        class="flex items-center gap-1 px-5 py-2 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 active:scale-95 sm:px-3 sm:py-1 sm:text-sm"
      >
        <span class="material-icons text-[18px] animate-pulse sm:text-[14px]"
          >send</span
        >
      </button>
    </div>
  </div>
</div>
<!-- Delete Confirmation Modal -->
<div
  *ngIf="showDeleteModal"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end md:items-center justify-center z-[100] animate-fadeIn"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full md:w-96 p-6 text-center relative transform transition-all duration-300"
  >
    <button
      (click)="cancelDelete()"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition"
      aria-label="Close"
    >
      <span class="material-icons text-[22px]">close</span>
    </button>

    <span class="material-icons text-red-500 text-6xl mb-3">warning</span>

    <h3 class="text-lg font-semibold text-gray-800 mb-2">
      Delete this message?
    </h3>
    <p class="text-sm text-gray-500 mb-6">This action cannot be undone.</p>

    <div class="flex justify-center gap-3">
      <button
        (click)="confirmDelete()"
        class="px-4 py-2 rounded-full text-white bg-gradient-to-r from-purple-600 to-red-600 hover:from-purple-700 hover:to-red-700 shadow-md transition"
      >
        <span class="material-icons text-[18px] mr-2">delete_forever</span>
        Delete
      </button>

      <button
        (click)="cancelDelete()"
        class="px-4 py-2 rounded-full text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-md transition"
      >
        <span class="material-icons text-[18px] mr-2">cancel</span>
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Edit Message Modal -->
<div
  *ngIf="showEditModal"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-[100] animate-fadeIn"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full md:w-96 p-6 text-center relative transform transition-all duration-300"
  >
    <button
      (click)="cancelEdit()"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition"
    >
      <span class="material-icons text-[22px]">close</span>
    </button>

    <h3 class="text-lg font-semibold text-gray-800 mb-3">Edit your message</h3>
    <textarea
      [(ngModel)]="editedMessage"
      rows="3"
      class="w-full border border-gray-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-sky-400 focus:border-sky-400"
    ></textarea>

    <div class="flex justify-end gap-3 mt-5">
      <button
        (click)="cancelEdit()"
        class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition"
      >
        <span class="material-icons text-[18px] mr-2">cancel</span>
        Cancel
      </button>
      <button
        (click)="saveEdit()"
        class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-green-500 to-sky-500 hover:from-green-600 hover:to-sky-600 shadow-md transition"
      >
        <span class="material-icons text-[18px] mr-2">save</span>
        Save
      </button>
    </div>
  </div>
</div>
