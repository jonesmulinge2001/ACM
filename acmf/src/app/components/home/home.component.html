<!-- Welcome Banner -->
<div
  class="rounded-lg px-6 py-6 mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border border-gray-200 shadow-sm"
>
  <!-- LinkedIn-style Post Box (Hidden on small screens) -->
  <div class="hidden md:block">
    <div
      class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 md:p-6 mx-auto"
    >
      <!-- Post Input -->
      <div class="hidden md:flex items-center space-x-3 mb-3">
        <img
          routerLink="my-profile"
          [src]="userProfile?.profileImage"
          alt="User avatar"
          class="w-10 h-10 rounded-full object-contain bg-gray-100 cursor-pointer"
        />
        <input
          routerLink="/create"
          type="text"
          placeholder="Share something with the student community"
          class="flex-1 bg-gray-100 cursor-pointer hover:bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 border border-gray-300 rounded-full px-4 py-2 text-gray-700 placeholder-gray-500 transition"
        />
      </div>

      <!-- Welcome Message -->
      <div class="mt-8 border-t pt-6 text-center max-w-2xl mx-auto">
        <h1
          class="text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight"
        >
          <span class="text-blue-700">Academeet</span>
        </h1>
        <p class="mt-2 text-sm md:text-base text-gray-700 italic">
          Empowering growth. Connecting ambitions. Fueling academic success.
        </p>
      </div>
    </div>

    <!-- CTA Buttons -->
    <div class="flex flex-wrap gap-3 mt-5 justify-center">
      <div class="flex flex-wrap gap-3">
        <button
          routerLink="/create"
          class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium px-5 py-1.5 rounded-full shadow-md hover:brightness-110 transition-all duration-200"
        >
          <span class="material-icons-outlined text-white text-base">edit</span>
          <span class="text-white text-sm">Share Your Post</span>
        </button>

        <button
          (click)="showUpload = true"
          class="flex items-center gap-2 bg-white text-gray-700 font-medium px-5 py-1.5 rounded-full hover:bg-gray-50 transition border border-gray-300 shadow-sm"
        >
          <span class="material-icons-outlined text-gray-600 text-base">
            cloud_upload
          </span>
          <span class="text-sm">Upload Resource</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<app-resource-upload-modal
  *ngIf="showUpload"
  (closeModal)="showUpload = false"
></app-resource-upload-modal>

<!-- Edit Post Modal -->
<app-edit-post
  *ngIf="showEditModal && selectedPostForEdit"
  [post]="selectedPostForEdit"
  [showModal]="showEditModal"
  (close)="onCloseEditModal()"
  (save)="onPostSave($event)"
></app-edit-post>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
  <!-- Feed -->
  <div
    class="lg:col-span-2 space-y-4"
    infiniteScroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="150"
    (scrolled)="loadMorePosts()"
  >
    <!-- Skeleton Loader -->
    <ng-container *ngIf="isLoading && posts.length === 0">
      <div
        *ngFor="let placeholder of [1, 2, 3]"
        class="animate-pulse bg-white rounded-lg border border-gray-200 p-4 space-y-3 shadow-sm"
      >
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-300 rounded w-3/4"></div>
            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
        <div class="h-3 bg-gray-200 rounded w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded w-full"></div>
        <div class="h-48 bg-gray-200 rounded"></div>
      </div>
    </ng-container>

    <!-- Actual Posts -->
    <div
      *ngFor="let post of posts"
      class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition p-4"
    >
      <!-- Header -->
      <div class="flex items-start gap-3 mb-3 relative">
        <a [routerLink]="['/profile', post.author.id]">
          <img
            [src]="post.author.profileImage || 'assets/default-avatar.png'"
            alt="Profile"
            loading="lazy"
            decoding="async"
            class="w-10 h-10 rounded-full bg-gray-100 object-contain border border-gray-300"
          />
        </a>

        <div>
          <a
            [routerLink]="['/profile', post.author.id]"
            class="font-medium text-sm text-gray-900 hover:text-blue-600"
          >
            {{ post.author.name }}
          </a>
          <p class="text-xs text-gray-500">
            {{ post.author.institution?.name || "" }} •
            {{ post.author.academicLevel || "" }}
          </p>
          <span class="text-xs text-gray-400">
            {{ post.createdAt | timeago }}
          </span>
        </div>

        <!-- Action Menu -->
        <div class="ml-auto relative">
          <!-- More button -->
          <button
            class="p-2 rounded-full hover:bg-gray-100 transition"
            (click)="toggleActionMenu($event, post.id)"
          >
            <span class="material-icons text-gray-600">more_vert</span>
          </button>

          <!-- Dropdown -->
          <div
            *ngIf="actionMenuOpen[post.id]"
            class="origin-top-right absolute right-0 top-10 w-52 bg-white border border-gray-200 rounded-xl shadow-lg z-50 animate-fade-in"
          >
            <!-- Edit -->
            <button
              *ngIf="post.author.id === loggedInUserId"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition"
              (click)="openEditModal(post)"
            >
              <span class="material-icons text-gray-500 text-base">edit</span>
              <span>Edit post</span>
            </button>

            <!-- Delete -->
            <button
              *ngIf="post.author.id === loggedInUserId"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition"
              (click)="openDeleteModal(post)"
            >
              <span class="material-icons text-red-500 text-base">delete</span>
              <span>Delete post</span>
            </button>

            <!-- Flag -->
            <button
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 transition"
              (click)="openFlagModal(post)"
            >
              <span class="material-icons text-orange-500 text-base">flag</span>
              <span>Flag post</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="cursor-pointer group" (click)="goToPost(post.id)">
        <h2
          class="text-base font-semibold text-gray-800 mb-1 group-hover:text-blue-600 transition"
        >
          {{ post.title }}
        </h2>

        <p class="text-gray-700 text-sm mb-2 leading-relaxed">
          {{ getPostPreview(post.body, post.id) }}
        </p>
      </div>

      <!-- Post type -->
      <span
        class="bg-blue-50 text-blue-700 px-3 py-0.5 rounded-full text-xs font-medium"
      >
        {{ post.type }}
      </span>

      <!-- Tags -->
      <div class="flex gap-2 flex-wrap mt-3">
        <span
          *ngFor="let tag of post.tags || []"
          class="bg-gray-100 text-gray-700 px-3 py-0.5 rounded-full text-xs font-medium hover:bg-gray-200 cursor-pointer"
        >
          #{{ tag }}
        </span>
      </div>

      <!-- Image -->
      <div *ngIf="post.fileUrl" class="mt-3 w-full overflow-hidden rounded-lg">
        <div class="w-full bg-black/5 flex justify-center">
          <img
            [src]="post.fileUrl"
            alt="Post image"
            loading="lazy"
            decoding="async"
            class="block max-w-full h-auto max-h-96 object-contain cursor-pointer"
            (click)="goToPost(post.id)"
          />
        </div>
      </div>

      <!-- Actions -->
      <div
        class="mt-4 border-t border-gray-100 pt-2 flex items-center gap-6 text-sm text-gray-600"
      >
        <!-- Like Button -->
        <button
          class="flex items-center gap-1.5 hover:text-blue-600 transition-colors group"
          (click)="togglePostLike(post)"
        >
          <span
            class="material-icons text-lg transition-colors"
            [class.text-red-500]="post.likedByCurrentUser"
            [class.text-gray-600]="!post.likedByCurrentUser"
            [class.group-hover:text-red-500]="!post.likedByCurrentUser"
          >
            {{ post.likedByCurrentUser ? "favorite" : "favorite_border" }}
          </span>
          <span>
            {{ post.likesCount | numberShort }}
            <span class="text-xs ml-0.5 text-gray-500">
              {{ post.likesCount === 1 ? "Like" : "Likes" }}
            </span>
          </span>
        </button>

        <!-- Comments Button -->
        <button
          class="flex items-center gap-1.5 hover:text-blue-600 transition-colors"
          (click)="toggleComments(post.id)"
        >
          <span class="material-icons text-lg">chat_bubble_outline</span>
          <span>
            {{ commentCounts[post.id] || 0 | numberShort }}
            <span class="text-xs ml-0.5 text-gray-500">
              {{ (commentCounts[post.id] || 0) === 1 ? "Comment" : "Comments" }}
            </span>
          </span>
        </button>

        <!-- Share Button -->
        <button
          class="flex items-center gap-1.5 hover:text-blue-600 transition-colors"
        >
          <span class="material-icons text-lg">share</span>
          <span class="text-gray-500 text-xs">Share</span>
        </button>
      </div>

      <!-- Comments Section -->
      <div
        *ngIf="commentVisible[post.id]"
        class="mt-4 pt-4 border-t border-gray-100 space-y-4"
      >
        <!-- Loading -->
        <div
          *ngIf="commentLoading[post.id]"
          class="flex items-center text-sm text-gray-500 italic"
        >
          <span class="material-icons animate-spin text-base mr-2"
            >refresh</span
          >
          Loading comments...
        </div>

        <!-- Comment List -->
        <div
          *ngFor="let comment of comments[post.id]"
          class="flex gap-3 p-3 rounded-xl bg-white/70 backdrop-blur border border-gray-100 shadow-sm"
        >
          <img
            [src]="comment.user.profile.profileImage"
            alt="User"
            class="w-9 h-9 rounded-full bg-gray-100 object-contain ring-2 ring-blue-100"
          />

          <div class="flex-1">
            <div class="flex items-center gap-2">
              <p class="text-sm font-semibold text-gray-800">
                {{ comment.user.name }}
                <span class="text-xs font-normal text-gray-400 ml-1">
                  {{ comment.createdAt | timeago }}
                </span>
              </p>

              
              <!-- 3-dot menu for own comments -->
              <div *ngIf="isMyComment(comment)" class="relative">
                <button
                  (click)="toggleMenu(comment.id)"
                  class="p-1 rounded-full hover:bg-gray-200"
                >
                  <span class="material-icons text-base">more_vert</span>
                </button>
        
                <!-- Dropdown -->
                <div
                  *ngIf="menuOpen[comment.id]"
                  class="absolute right-0 mt-1 w-24 bg-white border border-gray-200 rounded-md shadow-lg z-10"
                >
                  <button
                    (click)="openEditCommnetModal(comment)"
                    class="block w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-100"
                  >
                    Edit
                  </button>
                  <button
                    (click)="openDeleteCommentModal(comment)"
                    class="block w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-gray-100"
                  >
                    Delete
                  </button>
                </div>
              </div>
            </div>
        
            <p class="text-sm text-gray-700 leading-relaxed mt-0.5 ml-7">
              {{ comment.body }}
            </p>>

            <!-- Like + Reply -->
            <div class="flex gap-5 mt-2 text-xs font-medium ml-4">
              <button
                (click)="toggleLike(comment)"
                class="flex items-center gap-1 text-gray-500 hover:text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500 transition"
              >
                <span class="material-icons text-base">
                  {{
                    comment.isLikedByCurrentUser
                      ? "favorite"
                      : "favorite_border"
                  }}
                </span>
                <span>{{ comment.likes || 0 }}</span>
              </button>

              <button
                (click)="
                  repliesVisible[comment.id] = !repliesVisible[comment.id]
                "
                class="flex items-center gap-1 text-gray-500 hover:text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500 transition"
              >
                <span class="material-icons text-base">reply_all</span>

                <span>Replies</span>
              </button>
            </div>

            <!-- Reply Box -->
            <div
              *ngIf="repliesVisible[comment.id]"
              class="mt-3 ml-7 space-y-2 w-full"
            >
              <!-- Replies -->
              <div
                *ngFor="let reply of replies[comment.id]"
                class="flex gap-2 mt-2 ml-6 flex-wrap sm:flex-nowrap"
              >
                <span class="material-icons text-gray-400 text-sm"
                  >subdirectory_arrow_right</span
                >
                <img
                  [src]="reply.user.profile.profileImage"
                  class="w-6 h-6 rounded-full bg-gray-100 object-contain ring-1 ring-purple-200"
                />
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-1">
                    <p class="text-xs font-semibold text-gray-800 truncate">
                      {{ reply.user.name }}
                      <span class="text-[10px] text-gray-400 ml-1">
                        {{ reply.createdAt | timeago }}
                      </span>
                    </p>
                  </div>
                  <p class="text-xs text-gray-700 break-words">
                    {{ reply.body }}
                  </p>
                </div>
              </div>

              <!-- Reply Input -->
              <div
                class="flex flex-col sm:flex-row sm:items-center gap-2 w-full"
              >
                <span class="material-icons text-gray-400 text-sm"
                  >subdirectory_arrow_right</span
                >
                <input
                  type="text"
                  [(ngModel)]="replyInputs[comment.id]"
                  placeholder="Write a reply..."
                  class="flex-1 w-full sm:w-auto rounded-lg px-3 py-1.5 text-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-300"
                />

                <button
                  (click)="submitReply(comment.id)"
                  class="flex-1 sm:flex-none inline-flex justify-center items-center gap-1 text-xs font-semibold px-3 py-1 rounded-full text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:opacity-90 transition"
                >
                  <span class="material-icons text-sm">reply</span>
                  <span class="hidden sm:inline">Reply</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Add Comment -->
        <div
          class="flex flex-col sm:flex-row sm:items-center gap-2 mt-4 w-full"
        >
          <span class="material-icons text-gray-400 ml-1 sm:ml-0"
            >add_comment</span
          >

          <input
            [(ngModel)]="newComments[post.id]"
            placeholder="Write a comment..."
            class="flex-1 w-full sm:w-auto rounded-xl px-4 py-2 text-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-300"
          />

          <button
            (click)="submitComment(post.id)"
            class="flex-1 sm:flex-none inline-flex justify-center items-center gap-1 px-4 py-2 rounded-xl text-sm font-semibold text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:opacity-90 transition shadow-md"
          >
            <span class="material-icons text-sm">send</span>
            <span class="hidden sm:inline">Comment</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <ng-container *ngIf="isLoading && posts.length > 0">
      <div
        *ngFor="let placeholder of [1, 2]"
        class="animate-pulse bg-white rounded-lg border border-gray-200 p-4 space-y-2 shadow-sm"
      >
        <div class="h-4 bg-gray-300 rounded w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded w-full"></div>
      </div>
    </ng-container>

    <div
      *ngIf="nextCursor === null && !isLoading"
      class="flex justify-center py-4"
    >
      <span class="text-gray-400 text-sm">No more posts</span>
    </div>
  </div>

  <!-- Trending -->
  <div class="hidden lg:block space-y-4">
    <h2 class="text-base font-semibold text-gray-800">Trending Posts</h2>
    <div
      *ngFor="let post of trendingPosts"
      class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 space-y-3 hover:shadow-md transition"
    >
      <div class="flex items-center gap-3">
        <img
          [routerLink]="['/profile', post.author.id]"
          [src]="post.author.profileImage || 'assets/default-avatar.png'"
          alt="Profile Image"
          loading="lazy"
          decoding="async"
          class="w-10 h-10 rounded-full bg-gray-100 object-contain cursor-pointer border border-gray-300"
        />
        <div>
          <p class="text-sm font-medium text-gray-900">
            {{ post.author.name }}
          </p>
          <p class="text-xs text-gray-500">
            {{ post.author.institution?.name || "" }} •
            {{ post.author.academicLevel || "" }}
          </p>
          <p class="text-xs text-gray-400">{{ post.createdAt | timeago }}</p>
        </div>
      </div>

      <h3 class="text-sm font-semibold text-gray-800">{{ post.title }}</h3>
      <p class="text-xs text-gray-700 line-clamp-3 leading-relaxed">
        {{ post.body }}
      </p>

      <div *ngIf="post.fileUrl" class="mt-2 overflow-hidden rounded-lg">
        <div class="w-full flex justify-center bg-black/5">
          <img
            [src]="post.fileUrl"
            alt="Post image"
            loading="lazy"
            decoding="async"
            class="rounded-lg max-w-full h-auto max-h-72 object-contain cursor-pointer border border-gray-200"
          />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Flag Post Modal -->
<app-flag-post-modal
  *ngIf="showFlagModal && selectedPostToFlag"
  [postId]="selectedPostToFlag.id"
  (submitFlag)="onSubmitFlag($event)"
  (closeModal)="onCloseFlagModal()"
></app-flag-post-modal>

<!-- Delete Confirmation Modal -->
<div
  *ngIf="showDeleteModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm animate-fadeIn"
>
  <div
    class="bg-white rounded-t-2xl md:rounded-2xl shadow-lg w-full md:w-11/12 md:max-w-md p-6 text-center animate-scaleIn fixed bottom-0 md:relative md:translate-y-0 animate-slideUp md:animate-scaleIn"
  >
    <span class="material-icons text-red-500 text-4xl mb-3 animate-bounce-slow">
      warning
    </span>

    <h2 class="text-lg font-semibold text-gray-800 mb-2">Delete this post?</h2>

    <p class="text-sm text-gray-600 mb-5">
      This action cannot be undone. Are you sure you want to permanently delete
      this post?
    </p>

    <div class="flex justify-center gap-3">
      <button
        (click)="confirmDelete()"
        class="bg-red-600 text-white px-5 py-2 rounded-full hover:bg-red-700 transition flex items-center gap-1"
      >
        <span class="material-icons text-sm">delete_forever</span>
        Delete
      </button>

      <button
        (click)="showDeleteModal = false"
        class="bg-gray-100 text-gray-700 px-5 py-2 rounded-full hover:bg-gray-200 transition flex items-center gap-1"
      >
        <span class="material-icons text-sm">close</span>
        Cancel
      </button>
    </div>
  </div>
</div>


<!-- Edit Comment Modal -->
<div
  *ngIf="showEditModal && editingCommentId"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50"
>
  <div class="bg-white rounded-xl w-11/12 max-w-md p-5 shadow-lg">
    <h3 class="text-sm font-semibold text-gray-800 mb-3">Edit Comment</h3>

    <textarea
      [(ngModel)]="editedComment"
      rows="3"
      class="w-full border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
    ></textarea>

    <div class="flex justify-end gap-2 mt-4">
      <button
        (click)="cancelEdit()"
        class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-100"
      >
        Cancel
      </button>
      <button
        (click)="saveEdit()"
        class="px-4 py-2 text-sm rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:opacity-90"
      >
        Save
      </button>
    </div>
  </div>
</div>


<!-- Delete Comment Modal -->
<div
  *ngIf="showDeleteModal && commentToDelete"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50"
>
  <div class="bg-white rounded-xl w-11/12 max-w-sm p-5 shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-800 mb-4">
      Are you sure you want to delete this comment?
    </h3>

    <p class="text-xs text-gray-500 mb-4">
      This action cannot be undone.
    </p>

    <div class="flex justify-center gap-2">
      <button
        (click)="cancelDelete()"
        class="px-4 py-2 text-sm rounded-lg border border-gray-300 hover:bg-gray-100"
      >
        Cancel
      </button>
      <button
        (click)="conformDelete()"
        class="px-4 py-2 text-sm rounded-lg bg-red-600 text-white hover:opacity-90"
      >
        Delete
      </button>
    </div>
  </div>
</div>
