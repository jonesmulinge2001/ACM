<!-- Welcome Banner -->
<div
  class="rounded-xl px-6 py-8 mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border border-gray-200"
>
  <h1 class="text-xl md:text-2xl font-semibold text-gray-900 mb-2">
    Welcome to Academeet!
  </h1>
  <p class="text-sm md:text-base text-gray-700 mb-4">
    Connect with fellow students, share resources, and discover opportunities to
    grow your academic journey.
  </p>

  <div class="flex flex-wrap gap-3">
    <button
      routerLink="/create"
      class="bg-blue-600 text-white font-medium px-5 py-1.5 rounded-full hover:bg-blue-700 transition"
    >
      Share Your First Post
    </button>

    <button
      (click)="showUpload = true"
      class="bg-gray-100 text-gray-800 font-medium px-5 py-1.5 rounded-full hover:bg-gray-200 transition"
    >
      Upload Resource
    </button>
  </div>
</div>

<!-- Upload Modal -->
<app-resource-upload-modal
  *ngIf="showUpload"
  (closeModal)="showUpload = false"
></app-resource-upload-modal>

<!-- Edit Post Modal -->
<app-edit-post
  *ngIf="showEditModal && selectedPostForEdit"
  [post]="selectedPostForEdit"
  [showModal]="showEditModal"
  (close)="onCloseEditModal()"
  (save)="onPostSave($event)"
></app-edit-post>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6 px-4">
  <!-- Feed -->
  <div
    class="lg:col-span-2 space-y-4"
    infiniteScroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="150"
    (scrolled)="loadMorePosts()"
  >
    <!-- Skeleton Loader (initial load or loading more) -->
    <ng-container *ngIf="isLoading && posts.length === 0">
      <div
        *ngFor="let placeholder of [1, 2, 3]"
        class="animate-pulse bg-white rounded-lg shadow border border-gray-200 p-4 space-y-3"
      >
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-300 rounded w-3/4"></div>
            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>

        <div class="h-5 bg-gray-300 rounded w-5/6"></div>

        <div class="space-y-2">
          <div class="h-3 bg-gray-200 rounded w-full"></div>
          <div class="h-3 bg-gray-200 rounded w-11/12"></div>
          <div class="h-3 bg-gray-200 rounded w-10/12"></div>
        </div>

        <div class="flex gap-2">
          <div class="h-5 bg-gray-200 rounded w-12"></div>
          <div class="h-5 bg-gray-200 rounded w-16"></div>
          <div class="h-5 bg-gray-200 rounded w-10"></div>
        </div>

        <div class="h-48 bg-gray-200 rounded w-full mt-3"></div>

        <div class="flex gap-6 mt-4 h-4 bg-gray-200 rounded w-3/4"></div>
      </div>
    </ng-container>

    <!-- Actual Posts -->
    <div
      *ngFor="let post of posts"
      class="bg-white rounded-lg shadow border border-gray-200 hover:shadow-md transition p-4"
    >
      <!-- Header -->
      <div class="flex items-start gap-3 mb-3 relative">
        <a [routerLink]="['/profile', post.author.id]">
          <img
            [src]="post.author.profileImage || 'assets/default-avatar.png'"
            alt="Profile"
            class="w-10 h-10 rounded-full object-cover border border-gray-300"
          />
        </a>

        <div>
          <a
            [routerLink]="['/profile', post.author.id]"
            class="font-medium text-sm text-gray-900 hover:text-blue-600"
          >
            {{ post.author.name }}
          </a>
          <p class="text-xs text-gray-500">
            {{ post.author.institution || "" }} •
            {{ post.author.academicLevel || "" }}
          </p>
          <span class="text-xs text-gray-400">
            {{ post.createdAt | timeago }}
          </span>
        </div>

        <!-- Action Menu -->
        <div class="ml-auto">
          <button
            *ngIf="post.author.id === loggedInUserId"
            (click)="openActionMenu(post.id, $event)"
            class="p-1 rounded-full hover:bg-gray-100"
          >
            <i class="ri-more-2-fill text-gray-500"></i>
          </button>

          <div
            *ngIf="actionMenuOpen[post.id]"
            class="origin-top-right absolute right-0 top-8 w-40 bg-white border border-gray-200 rounded-md shadow-lg z-50"
          >
            <button
              class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50"
              (click)="openEditModal(post)"
            >
              Edit post
            </button>
            <button
              class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
              (click)="confirmDeletePost(post)"
            >
              Delete post
            </button>
          </div>
        </div>
      </div>

      <!-- Content -->
      <h2 class="text-base font-semibold text-gray-800 leading-tight mb-1">
        {{ post.title }}
      </h2>
      <p class="text-gray-700 text-sm mb-2">
        {{ getPostPreview(post.body, post.id) }}
        <button
          *ngIf="post.body && post.body.split(' ').length > 10"
          (click)="toggleReadMore(post.id)"
          class="text-blue-600 font-medium ml-1 hover:underline text-xs"
        >
          {{ isExpanded(post.id) ? "Read less" : "Read more" }}
        </button>
      </p>

      <span
        class="bg-blue-50 text-blue-700 px-3 py-0.5 rounded-full text-xs font-medium"
      >
        {{ post.type }}
      </span>

      <!-- Tags -->
      <div class="flex gap-2 flex-wrap mt-3">
        <span
          *ngFor="let tag of post.tags || []"
          class="bg-gray-100 text-gray-700 px-3 py-0.5 rounded-full text-xs font-medium hover:bg-gray-200 cursor-pointer"
        >
          #{{ tag }}
        </span>
      </div>

      <!-- Image -->
      <div *ngIf="post.fileUrl" class="mt-3">
        <img
          [src]="post.fileUrl"
          alt="Post image"
          class="rounded-lg w-full max-h-80 object-cover border border-gray-200"
        />
      </div>

      <!-- Actions -->
      <div
        class="mt-4 border-t border-gray-100 pt-2 flex items-center gap-6 text-sm text-gray-600"
      >
        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
          (click)="togglePostLike(post)"
        >
          <i
            [class]="'ri-heart-' + (post.likedByCurrentUser ? 'fill' : 'line')"
          ></i>
          <span>{{ post.likesCount | numberShort }}</span>
        </button>

        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
          (click)="toggleComments(post.id)"
        >
          <i class="ri-chat-3-line"></i>
          <span>{{ commentCounts[post.id] || 0 | numberShort }}</span>
        </button>

        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
        >
          <i class="ri-share-line"></i>
        </button>
      </div>
    </div>

    <!-- Infinite Scroll Loader (smaller placeholders) -->
    <ng-container *ngIf="isLoading && posts.length > 0">
      <div
        *ngFor="let placeholder of [1, 2]"
        class="animate-pulse bg-white rounded-lg shadow border border-gray-200 p-4 space-y-2"
      >
        <div class="h-4 bg-gray-300 rounded w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded w-full"></div>
        <div class="h-3 bg-gray-200 rounded w-11/12"></div>
      </div>
    </ng-container>

    <!-- End of Feed -->
    <div
      *ngIf="nextCursor === null && !isLoading"
      class="flex justify-center py-4"
    >
      <span class="text-gray-400 text-sm">No more posts</span>
    </div>
  </div>

  <!-- Trending Posts -->
  <div class="hidden lg:block space-y-4">
    <h2 class="text-base font-semibold text-gray-800">Trending Posts</h2>
    <div
      *ngFor="let post of trendingPosts"
      class="bg-white rounded-lg shadow border border-gray-200 p-4 space-y-3 hover:shadow-md transition"
    >
      <div class="flex items-center gap-3">
        <img
          [src]="post.author.profileImage || 'assets/default-avatar.png'"
          alt="Profile Image"
          class="w-10 h-10 rounded-full object-cover border border-gray-300"
        />
        <div>
          <p class="text-sm font-medium text-gray-900">
            {{ post.author.name }}
          </p>
          <p class="text-xs text-gray-500">
            {{ post.author.institution }} • {{ post.author.academicLevel }}
          </p>
          <p class="text-xs text-gray-400">{{ post.createdAt | timeago }}</p>
        </div>
      </div>

      <h3 class="text-sm font-semibold text-gray-800">{{ post.title }}</h3>
      <p class="text-xs text-gray-700 line-clamp-3">{{ post.body }}</p>

      <div *ngIf="post.fileUrl" class="mt-2">
        <img
          [src]="post.fileUrl"
          alt="Post image"
          class="rounded-lg w-full max-h-72 object-cover border border-gray-200"
        />
      </div>
    </div>
  </div>
</div>
