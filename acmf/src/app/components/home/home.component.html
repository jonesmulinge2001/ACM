<!-- Welcome Banner -->
<div
  class="rounded-lg px-6 py-6 mb-6 bg-gradient-to-r from-blue-50 to-purple-50 border border-gray-200 shadow-sm"
>
  <!-- LinkedIn-style Post Box -->
  <div
    class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 md:p-6 mx-auto"
  >
    <!-- Post Input -->
    <div class="flex items-center space-x-3 mb-3">
      <img
        [src]="userProfile?.profileImage"
        alt="User avatar"
        class="w-10 h-10 rounded-full object-cover"
      />
      <input
        type="text"
        placeholder="Share something with the community"
        class="flex-1 bg-gray-100 hover:bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 border border-gray-300 rounded-full px-4 py-2 text-gray-700 placeholder-gray-500 transition"
      />
    </div>

    <!-- Post Options -->
    <div
      class="flex w-full justify-between text-sm text-gray-600 mt-2 border-t border-gray-200 pt-2"
    >
      <button
        class="flex flex-1 justify-center items-center space-x-1 py-2 hover:bg-gray-50 hover:text-blue-600 rounded-lg transition"
      >
        <span class="material-icons-outlined text-green-600 text-base"
          >videocam</span
        >
        <span>Video</span>
      </button>

      <button
        class="flex flex-1 justify-center items-center space-x-1 py-2 hover:bg-gray-50 hover:text-blue-600 rounded-lg transition"
      >
        <span class="material-icons-outlined text-blue-500 text-base"
          >photo_camera</span
        >
        <span>Photo</span>
      </button>

      <button
        class="flex flex-1 justify-center items-center space-x-1 py-2 hover:bg-gray-50 hover:text-blue-600 rounded-lg transition"
      >
        <span class="material-icons-outlined text-orange-500 text-base"
          >article</span
        >
        <span>Write article</span>
      </button>
    </div>

    <!-- Welcome Message -->
    <div class="border-t border-gray-200 mt-4 pt-4 text-center">
      <h1 class="text-lg md:text-xl font-semibold text-gray-900 mb-1">
        Welcome to <span class="text-blue-600">Academeet!</span>
      </h1>
      <p class="text-sm md:text-base text-gray-600 leading-relaxed">
        Connect with fellow students, share resources, and discover
        opportunities to grow your academic journey.
      </p>
    </div>
  </div>

  <!-- CTA Buttons -->
  <div class="flex flex-wrap gap-3 mt-5 justify-center">
    <div class="flex flex-wrap gap-3">
      <button
        routerLink="/create"
        class="flex items-center gap-2 bg-blue-600 text-white font-medium px-5 py-1.5 rounded-full hover:bg-blue-700 transition"
      >
        <span class="material-icons-outlined text-white text-base">edit</span>
        <span>Share Your Post</span>
      </button>
    
      <button
        (click)="showUpload = true"
        class="flex items-center gap-2 bg-white text-gray-700 font-medium px-5 py-1.5 rounded-full hover:bg-gray-50 transition border border-gray-300 shadow-sm"
      >
        <span class="material-icons-outlined text-gray-600 text-base">cloud_upload</span>
        <span>Upload Resource</span>
      </button>
    </div>
    
  </div>
</div>

<!-- Upload Modal -->
<app-resource-upload-modal
  *ngIf="showUpload"
  (closeModal)="showUpload = false"
></app-resource-upload-modal>

<!-- Edit Post Modal -->
<app-edit-post
  *ngIf="showEditModal && selectedPostForEdit"
  [post]="selectedPostForEdit"
  [showModal]="showEditModal"
  (close)="onCloseEditModal()"
  (save)="onPostSave($event)"
></app-edit-post>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6 px-4">
  <!-- Feed -->
  <div
    class="lg:col-span-2 space-y-4"
    infiniteScroll
    [infiniteScrollDistance]="2"
    [infiniteScrollThrottle]="150"
    (scrolled)="loadMorePosts()"
  >
    <!-- Skeleton Loader -->
    <ng-container *ngIf="isLoading && posts.length === 0">
      <div
        *ngFor="let placeholder of [1, 2, 3]"
        class="animate-pulse bg-white rounded-lg border border-gray-200 p-4 space-y-3 shadow-sm"
      >
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-gray-300 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-300 rounded w-3/4"></div>
            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
        <div class="h-3 bg-gray-200 rounded w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded w-full"></div>
        <div class="h-48 bg-gray-200 rounded"></div>
      </div>
    </ng-container>

    <!-- Actual Posts -->
    <div
      *ngFor="let post of posts"
      class="bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition p-4"
    >
      <!-- Header -->
      <div class="flex items-start gap-3 mb-3 relative">
        <a [routerLink]="['/profile', post.author.id]">
          <img
            [src]="post.author.profileImage || 'assets/default-avatar.png'"
            alt="Profile"
            loading="lazy"
            decoding="async"
            class="w-10 h-10 rounded-full object-cover border border-gray-300 !aspect-square"
          />
        </a>

        <div>
          <a
            [routerLink]="['/profile', post.author.id]"
            class="font-medium text-sm text-gray-900 hover:text-blue-600"
          >
            {{ post.author.name }}
          </a>
          <p class="text-xs text-gray-500">
            {{ post.author.institution?.name || "" }} •
            {{ post.author.academicLevel || "" }}
          </p>
          <span class="text-xs text-gray-400">
            {{ post.createdAt | timeago }}
          </span>
        </div>

        <!-- Action Menu -->
        <div class="ml-auto relative">
          <!-- More button -->
          <button
            (click)="openActionMenu(post.id, $event)"
            class="p-2 rounded-full hover:bg-gray-100 transition"
          >
            <span class="material-icons text-gray-600">more_horiz</span>
          </button>

          <!-- Dropdown -->
          <div
            *ngIf="actionMenuOpen[post.id]"
            class="origin-top-right absolute right-0 top-10 w-52 bg-white border border-gray-200 rounded-xl shadow-lg z-50 animate-fade-in"
          >
            <!-- Edit -->
            <button
              *ngIf="post.author.id === loggedInUserId"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition"
              (click)="openEditModal(post)"
            >
              <span class="material-icons text-gray-500 text-base">edit</span>
              <span>Edit post</span>
            </button>

            <!-- Delete -->
            <button
              *ngIf="post.author.id === loggedInUserId"
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition"
              (click)="confirmDeletePost(post)"
            >
              <span class="material-icons text-red-500 text-base">delete</span>
              <span>Delete post</span>
            </button>

            <!-- Flag -->
            <button
              class="w-full flex items-center gap-3 px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 transition"
              (click)="openFlagModal(post)"
            >
              <span class="material-icons text-orange-500 text-base">flag</span>
              <span>Flag post</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Content -->
      <h2 class="text-base font-semibold text-gray-800 mb-1">
        {{ post.title }}
      </h2>
      <p class="text-gray-700 text-sm mb-2 leading-relaxed">
        {{ getPostPreview(post.body, post.id) }}
        <button
          *ngIf="post.body && post.body.split(' ').length > 10"
          (click)="toggleReadMore(post.id)"
          class="text-blue-600 font-medium ml-1 hover:underline text-xs"
        >
          {{ isExpanded(post.id) ? "Read less" : "Read more" }}
        </button>
      </p>

      <!-- Post type -->
      <span
        class="bg-blue-50 text-blue-700 px-3 py-0.5 rounded-full text-xs font-medium"
      >
        {{ post.type }}
      </span>

      <!-- Tags -->
      <div class="flex gap-2 flex-wrap mt-3">
        <span
          *ngFor="let tag of post.tags || []"
          class="bg-gray-100 text-gray-700 px-3 py-0.5 rounded-full text-xs font-medium hover:bg-gray-200 cursor-pointer"
        >
          #{{ tag }}
        </span>
      </div>

      <!-- Image -->
      <div *ngIf="post.fileUrl" class="mt-3">
        <img
          [src]="post.fileUrl"
          alt="Post image"
          loading="lazy"
          decoding="async"
          class="rounded-lg w-full max-h-[500px] object-cover border border-gray-200"
        />
      </div>

      <!-- Actions -->
      <div
        class="mt-4 border-t border-gray-100 pt-2 flex items-center gap-6 text-sm text-gray-600"
      >
        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
          (click)="togglePostLike(post)"
        >
          <i
            [class]="'ri-heart-' + (post.likedByCurrentUser ? 'fill' : 'line')"
          ></i>
          <span>{{ post.likesCount | numberShort }}</span>
        </button>

        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
          (click)="toggleComments(post.id)"
        >
          <i class="ri-chat-3-line"></i>
          <span>{{ commentCounts[post.id] || 0 | numberShort }}</span>
        </button>

        <button
          class="flex items-center gap-1 hover:text-blue-600 transition-colors"
        >
          <i class="ri-share-line"></i>
        </button>
      </div>

      <!-- ✅ Comments Section -->
      <div
        *ngIf="commentVisible[post.id]"
        class="mt-3 border-t border-gray-100 pt-3 space-y-3"
      >
        <!-- Loading -->
        <p *ngIf="commentLoading[post.id]" class="text-sm text-gray-500">
          Loading comments...
        </p>

        <!-- Comment List -->
        <div *ngFor="let comment of comments[post.id]" class="flex gap-3">
          <img
            [src]="comment.user.profile.profileImage"
            alt="User"
            class="w-8 h-8 rounded-full object-cover border border-gray-300"
          />
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-800">
              {{ comment.user.name }}
              <span class="text-xs text-gray-400 ml-1">
                {{ comment.createdAt | timeago }}
              </span>
            </p>
            <p class="text-sm text-gray-700 leading-relaxed">
              {{ comment.body }}
            </p>

            <!-- Like + Reply Actions -->
            <div class="flex gap-4 mt-1 text-xs text-gray-500">
              <button
                (click)="toggleLike(comment)"
                class="flex items-center gap-1 hover:text-blue-600"
              >
                <i
                  [class]="
                    'ri-heart-' +
                    (comment.isLikedByCurrentUser ? 'fill' : 'line')
                  "
                ></i>
                <span>{{ comment.likes || 0 }}</span>
              </button>

              <button
                (click)="
                  repliesVisible[comment.id] = !repliesVisible[comment.id]
                "
                class="hover:text-blue-600"
              >
                Replies
              </button>
            </div>

            <!-- Reply Box -->
            <div *ngIf="repliesVisible[comment.id]" class="mt-2 ml-8">
              <input
                type="text"
                [(ngModel)]="replyInputs[comment.id]"
                placeholder="Write a reply..."
                class="w-full border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring focus:ring-blue-200"
              />
              <button
                (click)="submitReply(comment.id)"
                class="mt-1 text-xs text-blue-600 font-medium hover:underline"
              >
                Reply
              </button>

              <!-- Replies -->
              <div
                *ngFor="let reply of replies[comment.id]"
                class="mt-2 flex gap-2"
              >
                <img
                  [src]="reply.user.profile.profileImage"
                  class="w-6 h-6 rounded-full border border-gray-300"
                />
                <div>
                  <p class="text-xs font-medium text-gray-800">
                    {{ reply.user.name }}
                    <span class="text-[10px] text-gray-400 ml-1">
                      {{ reply.createdAt | timeago }}
                    </span>
                  </p>
                  <p class="text-xs text-gray-700">{{ reply.body }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add New Comment -->
        <div class="flex gap-2 items-center mt-3">
          <input
            [(ngModel)]="newComments[post.id]"
            placeholder="Write a comment..."
            class="flex-1 border border-gray-300 rounded-lg px-3 py-1 text-sm focus:ring focus:ring-blue-200"
          />
          <button
            (click)="submitComment(post.id)"
            class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition"
          >
            Comment
          </button>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <ng-container *ngIf="isLoading && posts.length > 0">
      <div
        *ngFor="let placeholder of [1, 2]"
        class="animate-pulse bg-white rounded-lg border border-gray-200 p-4 space-y-2 shadow-sm"
      >
        <div class="h-4 bg-gray-300 rounded w-5/6"></div>
        <div class="h-3 bg-gray-200 rounded w-full"></div>
      </div>
    </ng-container>

    <div
      *ngIf="nextCursor === null && !isLoading"
      class="flex justify-center py-4"
    >
      <span class="text-gray-400 text-sm">No more posts</span>
    </div>
  </div>

  <!-- Trending -->
  <div class="hidden lg:block space-y-4">
    <h2 class="text-base font-semibold text-gray-800">Trending Posts</h2>
    <div
      *ngFor="let post of trendingPosts"
      class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 space-y-3 hover:shadow-md transition"
    >
      <div class="flex items-center gap-3">
        <img
          [src]="post.author.profileImage || 'assets/default-avatar.png'"
          alt="Profile Image"
          loading="lazy"
          decoding="async"
          class="w-10 h-10 rounded-full object-cover border border-gray-300 !aspect-square"
        />
        <div>
          <p class="text-sm font-medium text-gray-900">
            {{ post.author.name }}
          </p>
          <p class="text-xs text-gray-500">
            {{ post.author.institution?.name || "" }} •
            {{ post.author.academicLevel || "" }}
          </p>
          <p class="text-xs text-gray-400">{{ post.createdAt | timeago }}</p>
        </div>
      </div>

      <h3 class="text-sm font-semibold text-gray-800">{{ post.title }}</h3>
      <p class="text-xs text-gray-700 line-clamp-3 leading-relaxed">
        {{ post.body }}
      </p>

      <div *ngIf="post.fileUrl" class="mt-2">
        <img
          [src]="post.fileUrl"
          alt="Post image"
          loading="lazy"
          decoding="async"
          class="rounded-lg w-full max-h-72 object-cover border border-gray-200"
        />
      </div>
    </div>
  </div>
</div>

<!-- Flag Post Modal -->
<app-flag-post-modal
  *ngIf="showFlagModal && selectedPostToFlag"
  [postId]="selectedPostToFlag.id"
  (submitFlag)="onSubmitFlag($event)"
  (closeModal)="onCloseFlagModal()"
></app-flag-post-modal>
