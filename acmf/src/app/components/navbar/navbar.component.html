<!-- Main Navbar -->
<div
  class="fixed top-0 left-0 right-0 z-55 bg-white shadow-sm px-4 py-3 h-16 flex items-center justify-between"
>
  <!-- Logo -->
  <div class="flex items-center space-x-2">
    <img
      routerLink="/"
      src="logo.png"
      alt="academeet logo"
      class="h-8 w-32 object-cover cursor-pointer"
    />
  </div>

  <!-- Search Bar (hidden on small screens) -->
  <div class="search-container relative flex-1 max-w-xl mx-6">
    <div
      class="hidden sm:flex items-center w-[380px] px-4 py-2.5 rounded-full
             bg-white/70 backdrop-blur-md
             border border-gray-200 shadow-sm
             transition-all duration-200
             hover:shadow-md
             focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-400"
    >
      <span class="material-icons text-gray-400 mr-3 text-[20px]">
        search
      </span>
    
      <input
        type="search"
        [(ngModel)]="searchQuery"
        (input)="onSearchQueryChange($any($event.target).value)"
        (focus)="searchPanelOpen = true"
        placeholder="Search students, posts, resources..."
        class="flex-1 bg-transparent outline-none text-sm text-gray-800
               placeholder-gray-400"
      />
    </div>
    
    <!-- Search Results Dropdown -->
    <div
      *ngIf="searchPanelOpen && searchQuery.trim()"
      class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-200 z-50 max-h-96 overflow-y-auto"
    >
      <div class="p-4">
        <!-- Loading State -->
        <div *ngIf="loading" class="flex justify-center py-4">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
          ></div>
        </div>

        <!-- Results -->
        <div *ngIf="!loading">
          <!-- Students -->
          <div *ngIf="searchResults.profiles.length" class="mb-6">
            <h3
              class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wide"
            >
              Students
            </h3>
            <div class="space-y-2">
              <div
                *ngFor="let p of searchResults.profiles"
                (click)="onSearchItemClick()"
                class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors"
                (click)="p.id ? navigateToProfile(p.id) : null"
              >
                <img
                  [src]="p.profileImage || 'https://via.placeholder.com/40'"
                  class="w-10 h-10 rounded-full object-cover"
                />
                <div>
                  <p class="font-medium text-sm">{{ p.name }}</p>
                  <p class="text-xs text-gray-500">{{ p.course }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Posts -->
          <div *ngIf="searchResults.posts.length" class="mb-6">
            <h3
              class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wide"
            >
              Posts
            </h3>
            <div class="space-y-2">
              <div
                *ngFor="let post of searchResults.posts"
                (click)="onSearchItemClick()"
                class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors"
                (click)="post.id ? navigateToPost(post.id) : null"
              >
                <p class="font-medium text-sm">{{ post.title }}</p>
                <p class="text-sm text-gray-600 mt-1" *ngIf="post.body">
                  {{ post.body | slice : 0 : 80 }}...
                </p>
              </div>
            </div>
          </div>

          <!-- Resources -->
          <div *ngIf="searchResults.resources.length" class="mb-6">
            <h3
              class="font-semibold text-gray-700 mb-3 text-sm uppercase tracking-wide"
            >
              Resources
            </h3>
            <div class="space-y-2">
              <div
                *ngFor="let r of searchResults.resources"
                (click)="onSearchItemClick()"
                class="p-3 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors"
                (click)="r.id ? navigateToPost(r.id) : null"
              >
                <p class="font-medium text-sm">{{ r.title }}</p>
                <p class="text-xs text-gray-500 mt-1">
                  {{ r.course }} · {{ r.unitName }}
                </p>
              </div>
            </div>
          </div>

          <!-- No Results -->
          <div
            *ngIf="
              !searchResults.profiles.length &&
              !searchResults.posts.length &&
              !searchResults.resources.length
            "
            class="text-center py-6 text-gray-500"
          >
            <span class="material-icons text-3xl mb-2 text-gray-400"
              >search_off</span
            >
            <p class="text-sm">No results found for "{{ searchQuery }}"</p>
          </div>

          <!-- View All Results -->
          <div
            *ngIf="
              searchResults.profiles.length ||
              searchResults.posts.length ||
              searchResults.resources.length
            "
            class="border-t border-gray-100 pt-4"
          >
            <button
              (click)="viewAllResults()"
              class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
            >
              <span class="text-sm font-medium">View all results</span>
              <span class="material-icons text-sm">arrow_forward</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Engagement Icons -->
  <div class="flex items-center space-x-4">
    <!-- Mobile Search Button -->
    <button
      routerLink="/search"
      (click)="toggleSearchPanel()"
      class="material-icons text-gray-500 text-2xl cursor-pointer sm:hidden"
    >
      search
    </button>

    <!-- Notifications Component -->
    <app-notification></app-notification>

    <!-- Chat -->
    <button
      routerLink="/messages"
      class="material-icons text-gray-500 text-2xl cursor-pointer hover:text-blue-600 transition-colors"
    >
      chat
    </button>

    <!-- User Profile Dropdown -->
    <ng-container *ngIf="isLoggedIn">
      <div class="profile-dropdown-container relative select-none">
        <!-- Profile Trigger -->
        <div 
          class="flex items-center space-x-2 cursor-pointer group"
          (click)="toggleMenu()"
        >
          <img
            [src]="userImage"
            class="w-8 h-8 rounded-full object-cover border border-gray-200 group-hover:border-blue-500 transition"
            alt="user"
          />
          <span
            class="text-xs font-medium hidden sm:inline text-gray-700 group-hover:text-blue-600"
          >
            {{ userName }}
          </span>
          <span
            class="material-icons text-gray-600 text-sm sm:inline hidden group-hover:text-blue-600 transition-transform duration-200"
            [class.rotate-180]="menuOpen"
          >
            expand_more
          </span>
        </div>

        <!-- Dropdown Menu -->
        <div
          *ngIf="menuOpen"
          class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-lg py-2 z-50 transform transition-all duration-200 ease-out origin-top opacity-100 scale-100"
        >
          <!-- View Profile -->
          <button
            (click)="viewProfile()"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
          >
            <!-- User Image with hover effect -->
            <img
              *ngIf="userImage; else defaultIcon"
              [src]="userImage"
              alt="User"
              class="w-6 h-6 rounded-full mr-2 object-cover border border-gray-300"
            />

            <!-- Fallback icon -->
            <ng-template #defaultIcon>
              <span class="material-icons text-blue-500 text-lg mr-2"
                >person</span
              >
            </ng-template>

            My Profile
          </button>

          <!-- Settings -->
          <button
            routerLink="/settings"
            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors"
          >
            <span class="material-icons text-gray-500 text-lg mr-2">settings</span>
            Settings
          </button>

          <!-- Divider -->
          <div class="border-t border-gray-100 my-2"></div>

          <!-- Logout -->
          <button
            (click)="openLogoutModal()"
            class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
          >
            <span class="material-icons text-red-500 text-lg mr-2">logout</span>
            Logout
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<!-- Mobile Search Modal -->
<div
  *ngIf="searchPanelOpen && window.innerWidth < 640"
  class="fixed inset-0 z-60 bg-white"
>
  <div class="flex flex-col h-full">
    <!-- Search Header -->
    <div class="flex items-center p-4 border-b border-gray-200">
      <button
        (click)="closeSearchPanel()"
        class="material-icons text-gray-600 mr-4"
      >
        arrow_back
      </button>
      <div class="flex-1 relative">
        <span
          class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
        >
          search
        </span>
        <input
          type="search"
          [(ngModel)]="searchQuery"
          (input)="onSearchQueryChange($any($event.target).value)"
          placeholder="Search students, posts, resources..."
          class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-full outline-none"
          autofocus
        />
      </div>
    </div>

    <!-- Search Results -->
    <div class="flex-1 overflow-y-auto p-4">
      <!-- Loading State -->
      <div *ngIf="loading" class="flex justify-center py-8">
        <div
          class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"
        ></div>
      </div>

      <!-- Results -->
      <div *ngIf="!loading && searchQuery.trim()">
        <!-- Students -->
        <div *ngIf="searchResults.profiles.length" class="mb-8">
          <h3 class="font-semibold text-gray-700 mb-4">Students</h3>
          <div class="space-y-3">
            <div
              *ngFor="let p of searchResults.profiles"
              (click)="onSearchItemClick()"
              class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl cursor-pointer"
            >
              <img
                [src]="p.profileImage || 'https://via.placeholder.com/40'"
                class="w-12 h-12 rounded-full object-cover"
              />
              <div>
                <p class="font-medium">{{ p.name }}</p>
                <p class="text-sm text-gray-500">{{ p.course }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Posts -->
        <div *ngIf="searchResults.posts.length" class="mb-8">
          <h3 class="font-semibold text-gray-700 mb-4">Posts</h3>
          <div class="space-y-3">
            <div
              *ngFor="let post of searchResults.posts"
              (click)="onSearchItemClick()"
              class="p-4 bg-gray-50 rounded-xl cursor-pointer"
            >
              <p class="font-medium">{{ post.title }}</p>
              <p class="text-sm text-gray-600 mt-2" *ngIf="post.body">
                {{ post.body | slice : 0 : 120 }}...
              </p>
            </div>
          </div>
        </div>

        <!-- Resources -->
        <div *ngIf="searchResults.resources.length" class="mb-8">
          <h3 class="font-semibold text-gray-700 mb-4">Resources</h3>
          <div class="space-y-3">
            <div
              *ngFor="let r of searchResults.resources"
              (click)="onSearchItemClick()"
              class="p-4 bg-gray-50 rounded-xl cursor-pointer"
            >
              <p class="font-medium">{{ r.title }}</p>
              <p class="text-sm text-gray-500 mt-1">
                {{ r.course }} · {{ r.unitName }}
              </p>
            </div>
          </div>
        </div>

        <!-- No Results -->
        <div
          *ngIf="
            !searchResults.profiles.length &&
            !searchResults.posts.length &&
            !searchResults.resources.length
          "
          class="text-center py-12"
        >
          <span class="material-icons text-4xl mb-4 text-gray-400"
            >search_off</span
          >
          <p class="text-gray-500">No results found for "{{ searchQuery }}"</p>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!searchQuery.trim()" class="text-center py-12">
        <span class="material-icons text-4xl mb-4 text-gray-300">search</span>
        <p class="text-gray-500">Type to start searching</p>
      </div>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div
  *ngIf="logoutModalOpen"
  class="fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-70"
  (click)="logoutModalOpen = false"
>
  <div
    class="bg-white rounded-2xl shadow-2xl p-6 w-80 max-w-sm relative"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center mb-4">
      <span class="material-icons text-red-500 mr-2 text-2xl">logout</span>
      <h3 class="text-lg font-bold text-gray-900">Confirm Logout</h3>
    </div>

    <!-- Body -->
    <p class="text-gray-600 mb-6">
      Are you sure you want to log out? Your session will be ended immediately.
    </p>

    <!-- Actions -->
    <div class="flex justify-end space-x-3">
      <button
        (click)="logoutModalOpen = false"
        class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-100 transition-all duration-300"
      >
        <span class="material-icons text-gray-500 text-base">cancel</span>
        Cancel
      </button>

      <button
        (click)="logOut()"
        class="flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600 shadow-lg transition-all duration-300"
      >
        <span class="material-icons text-white text-base">logout</span>
        Logout
      </button>
    </div>
  </div>
</div>