<div
  class="flex flex-col h-[60vh] bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden relative transition"
>
  <!-- Messages -->
  <div
    #messagesContainer
    class="flex-1 p-4 overflow-auto space-y-3 scroll-smooth bg-gray-50"
  >
    <div *ngFor="let m of messages" class="relative group">
      <!-- My message -->
      <div *ngIf="isMyMessage(m); else otherMsg" class="flex justify-end">
        <div
          class="relative max-w-xs bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-2xl px-4 py-2 shadow-md transition transform hover:scale-[1.01]"
        >
          <!-- Replied message bubble -->
          <div
            *ngIf="m.replyTo"
            class="bg-blue-500/40 border-l-4 border-blue-300 rounded-md p-1 mb-1 text-xs text-blue-100 italic"
          >
            <span class="font-semibold text-white">{{ m.replyTo.user?.name }}:</span>
            {{ m.replyTo.content | slice: 0:40
            }}{{ m.replyTo.content.length > 40 ? "..." : "" }}
          </div>

          <!-- Message text -->
          <div class="text-sm leading-snug break-words">{{ m.content }}</div>

          <!-- Timestamp -->
          <div class="text-[10px] text-blue-200 text-right mt-1 select-none">
            {{ m.createdAt | date : "MMM d, h:mm a" }}
          </div>

          <!-- 3-dot menu -->
          <div class="absolute top-1 right-1">
            <button
              (click)="toggleMenu(m.id)"
              class="opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1 rounded-full hover:bg-blue-700"
            >
              <span class="material-icons text-sm text-white">more_vert</span>
            </button>

            <!-- Dropdown menu -->
            <div
              *ngIf="menuOpen[m.id]"
              class="absolute right-0 mt-2 bg-white text-gray-800 rounded-lg shadow-lg w-32 z-50 transition transform origin-top-right animate-fadeIn"
            >
              <button
                (click)="replyToMessage(m)"
                class="flex items-center w-full px-3 py-2 text-sm hover:bg-gray-100 transition text-blue-600"
              >
                <span class="material-icons text-[18px] mr-2 text-blue-600">reply</span>
                Reply
              </button>
              <button
                (click)="openEditModal(m)"
                class="flex items-center w-full px-3 py-2 text-sm hover:bg-gray-100 transition"
              >
                <span class="material-icons text-[18px] mr-2 text-blue-600">edit</span>
                Edit
              </button>
              <button
                (click)="openDeleteModal(m)"
                class="flex items-center w-full px-3 py-2 text-sm hover:bg-gray-100 transition text-red-600"
              >
                <span class="material-icons text-[18px] mr-2 text-red-600">delete</span>
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Other message -->
      <ng-template #otherMsg>
        <div class="flex items-start space-x-2">
          <img
            [src]="
              m.user?.profileImage ||
              'https://ui-avatars.com/api/?name=' + m.user?.name
            "
            alt="User avatar"
            class="w-9 h-9 rounded-full ring-1 ring-gray-200 object-cover"
          />
          <div
            class="max-w-xs bg-white text-gray-800 rounded-2xl px-4 py-2 shadow-sm border border-gray-100 transition hover:shadow-md"
          >
            <div class="text-xs font-semibold text-gray-700">
              {{ m.user?.name }}
            </div>

            <!-- Replied message bubble -->
            <div
              *ngIf="m.replyTo"
              class="bg-gray-100 border-l-4 border-gray-300 rounded-md p-1 mb-1 text-xs text-gray-600 italic"
            >
              <span class="font-semibold text-gray-700">{{ m.replyTo.user?.name }}:</span>
              {{ m.replyTo.content | slice: 0:40
              }}{{ m.replyTo.content.length > 40 ? "..." : "" }}
            </div>

            <div class="text-sm leading-snug break-words">{{ m.content }}</div>
            <div class="text-[10px] text-gray-400 mt-1 select-none">
              {{ m.createdAt | date : "MMM d, h:mm a" }}
            </div>

            <!-- Reply button -->
            <button
            (click)="replyToMessage(m)"
            class="mt-1 flex items-center gap-1 text-xs text-blue-500"
          >
            <span class="material-icons text-[16px]">reply</span>
          </button>
          
          </div>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Floating new message button -->
  <button
    *ngIf="showNewMessageButton"
    (click)="jumpToBottom()"
    class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white px-4 py-1.5 rounded-full shadow-md text-sm transition-all"
  >
    ⬇ New messages
  </button>

  <!-- Replying To Preview -->
  <div
    *ngIf="replyingTo"
    class="flex items-center justify-between bg-blue-50 border-l-4 border-blue-500 px-3 py-2 text-sm text-gray-700"
  >
    <div>
      Replying to
      <span class="font-semibold">{{ replyingTo.user?.name }}</span>:
      <span class="italic text-gray-500">
        “{{ replyingTo.content | slice: 0:50
        }}{{ replyingTo.content.length > 50 ? "..." : "" }}”
      </span>
    </div>
    <button (click)="cancelReply()" class="text-gray-500 hover:text-red-500 transition">
      <span class="material-icons text-[18px]">close</span>
    </button>
  </div>

  <!-- Input -->
  <div
    class="p-3 border-t border-gray-200 bg-white flex items-center space-x-3"
  >
    <input
      [formControl]="messageControl"
      placeholder="Write a message..."
      class="flex-1 bg-gray-100 hover:bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 border border-gray-300 rounded-full px-4 py-2 text-sm text-gray-700 placeholder-gray-500 transition"
    />
    <button
      (click)="send()"
      aria-label="Send message"
      class="flex items-center justify-center w-10 h-10 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white rounded-full shadow-sm transition-all"
    >
      <span class="material-icons text-[22px]">send</span>
    </button>

    <!-- Delete Confirmation Modal -->
    <div
      *ngIf="showDeleteModal"
      class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-end md:items-center justify-center z-[100] animate-fadeIn"
    >
      <div
        class="bg-white rounded-t-3xl md:rounded-2xl shadow-2xl w-full md:w-80 p-6 text-center relative transform transition-all duration-300 animate-slideUp md:animate-scaleIn"
      >
        <button
          (click)="cancelDelete()"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition"
        >
          <span class="material-icons text-[22px]">close</span>
        </button>

        <span
          class="material-icons text-red-500 text-6xl mb-3 animate-bounce-slow"
        >
          warning
        </span>

        <h3 class="text-lg font-semibold text-gray-800 mb-2">
          Delete this message?
        </h3>
        <p class="text-sm text-gray-500 mb-6">This action cannot be undone.</p>

        <div class="flex justify-center gap-3">
          <button
            (click)="confirmDelete()"
            class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1"
          >
            <span class="material-icons text-[18px]">delete_forever</span>
            Delete
          </button>
          <button
            (click)="cancelDelete()"
            class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1"
          >
            <span class="material-icons text-[18px]">cancel</span>
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Message Modal -->
    <div
      *ngIf="showEditModal"
      class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center md:items-center z-[100] animate-fadeIn"
    >
      <div
        class="bg-white rounded-t-3xl md:rounded-2xl shadow-2xl w-full md:w-96 p-6 text-center relative transform transition-all duration-300 animate-slideUp md:animate-scaleIn"
      >
        <button
          (click)="cancelEdit()"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 transition"
        >
          <span class="material-icons text-[22px]">close</span>
        </button>

        <h3 class="text-lg font-semibold text-gray-800 mb-3">
          Edit your message
        </h3>
        <textarea
          [(ngModel)]="editedMessage"
          rows="3"
          class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        ></textarea>

        <div class="flex justify-end gap-3 mt-5">
          <button
            (click)="cancelEdit()"
            class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1"
          >
            <span class="material-icons text-[18px]">cancel</span>
            Cancel
          </button>
          <button
            (click)="saveEdit()"
            class="px-4 py-2 rounded-lg text-white bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 shadow-md hover:shadow-lg transition-all duration-300 flex items-center gap-1"
          >
            <span class="material-icons text-[18px]">save</span>
            Save
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
